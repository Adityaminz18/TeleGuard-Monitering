{% extends "base.html" %}

{% block title %}Login - TeleGuard{% endblock %}

{% block content %}
<div class="flex items-center justify-center min-h-[calc(100vh-4rem)]">
    <div class="w-full max-w-md p-8 glass rounded-2xl">
        <h2
            class="text-3xl font-bold text-center mb-8 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">
            Welcome Back</h2>

        <form class="space-y-6" hx-post="/api/v1/auth/login" hx-swap="none" id="loginForm">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-300">Email address</label>
                <input id="email" name="username" type="email" required
                    class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
                <input id="password" name="password" type="password" required
                    class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>

            <div>
                <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Sign in
                </button>
            </div>
        </form>

        <p class="mt-4 text-center text-sm text-gray-400">
            Don't have an account? <a href="/register" class="text-indigo-400 hover:text-indigo-300">Sign up</a>
        </p>

        <div id="error-message" class="mt-4 text-center text-red-500 text-sm hidden"></div>
    </div>
</div>

<script>
    document.getElementById('loginForm').addEventListener('htmx:afterRequest', function (evt) {
        if (evt.detail.successful) {
            try {
                const response = JSON.parse(evt.detail.xhr.response);
                if (response.access_token) {
                    console.log("Login successful, setting token...");
                    localStorage.setItem('token', response.access_token);
                    window.location.href = '/dashboard';
                } else {
                    throw new Error("No access token in response");
                }
            } catch (e) {
                console.error("Login Error:", e);
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = "Login successful but failed to process response.";
                errorDiv.classList.remove('hidden');
            }
        } else {
            console.error("Login Failed Request", evt.detail);
            const errorDiv = document.getElementById('error-message');
            let msg = "Login failed";
            try {
                const errResp = JSON.parse(evt.detail.xhr.response);
                if (errResp.detail) msg += ": " + errResp.detail;
            } catch (e) { }
            errorDiv.textContent = msg;
            errorDiv.classList.remove('hidden');
        }
    });
</script>
{% endblock %}